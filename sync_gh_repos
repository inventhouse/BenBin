#!/bin/bash
# Copyright (c) 2022-2025 Benjamin Holt -- MIT License

set -eo pipefail
# set -x  # Uncomment for debugging

if [ "$1" == "-h" -o "$1" == "--help" ]; then
    cat <<USAGE
usage: sync_gh_repos [-h|--help] <organization_name>
    Sync GitHub repositories for a given organization; requires GitHub CLI (gh).
    Clones repositories that don't exist locally and pulls updates for those that do.

        -h, --help    Print this message and exit
USAGE
    exit 0
fi

if [ $# -eq 0 ]; then
    echo "Usage: $0 <organization_name>"
    exit 1
fi

ORG_NAME="$1"
CURRENT_DIR=$(pwd)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}Syncing repositories for organization: ${ORG_NAME}${NC}"
echo -e "${BLUE}Working directory: ${CURRENT_DIR}${NC}"
echo

# Check if gh CLI is installed
if ! command -v gh &> /dev/null; then
    echo -e "${RED}Error: GitHub CLI (gh) is not installed or not in PATH${NC}"
    echo "Please install it from https://cli.github.com/"
    exit 1
fi

# Check if user is authenticated
if ! gh auth status &> /dev/null; then
    echo -e "${RED}Error: Not authenticated with GitHub CLI${NC}"
    echo "Please run 'gh auth login' first"
    exit 1
fi

echo -e "${YELLOW}Fetching repository list from GitHub...${NC}"

# Function to fetch repositories with pagination and rate limiting
fetch_repos_paginated() {
    local org="$1"
    local page=1
    local per_page=100
    local all_repos=""

    while true; do
        echo -e "${YELLOW}  Fetching page $page (up to $per_page repos)...${NC}"

        # Fetch repos for this page with retry logic
        local page_repos
        local retry_count=0
        local max_retries=3

        while [ $retry_count -lt $max_retries ]; do
            if page_repos=$(gh repo list "$org" --limit $per_page --json name,sshUrl --jq '.[] | "\(.name)|\(.sshUrl)"' 2>/dev/null); then
                break
            else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                    echo -e "${YELLOW}  API call failed, retrying in $((retry_count * 2)) seconds... (attempt $retry_count/$max_retries)${NC}"
                    sleep $((retry_count * 2))
                else
                    echo -e "${RED}  Failed to fetch repositories after $max_retries attempts${NC}"
                    return 1
                fi
            fi
        done

        if [ -z "$page_repos" ]; then
            break
        fi

        all_repos="$all_repos$page_repos"$'\n'

        # Check if we got fewer repos than requested (last page)
        local repo_count=$(echo "$page_repos" | wc -l)
        if [ "$repo_count" -lt $per_page ]; then
            break
        fi

        page=$((page + 1))

        # Rate limiting: sleep between API calls
        echo -e "${YELLOW}  Sleeping 2 seconds to respect rate limits...${NC}"
        sleep 2
    done

    echo "$all_repos"
}

# Get all repositories for the organization with pagination
REPOS=$(fetch_repos_paginated "$ORG_NAME")

if [ -z "$REPOS" ]; then
    echo -e "${RED}No repositories found for organization: ${ORG_NAME}${NC}"
    echo "Please check the organization name and your access permissions"
    exit 1
fi

echo -e "${GREEN}Found $(echo "$REPOS" | grep -c '|') repositories${NC}"
echo

# Process each repository
while IFS='|' read -r repo_name ssh_url; do
    echo -e "${BLUE}Processing: ${repo_name}${NC}"
    
    if [ -d "$repo_name" ]; then
        # Repository exists locally - update it
        echo -e "  ðŸª„ ${YELLOW}Repository exists locally, updating...${NC}"
        cd "$repo_name"
        
        # Check if it's actually a git repository
        if [ ! -d ".git" ]; then
            echo -e "${RED}  Warning: ${repo_name} exists but is not a git repository${NC}"
            cd "$CURRENT_DIR"
            continue
        fi
        
        # Fetch and pull latest changes
        if git fetch origin && git pull -r origin "$(git symbolic-ref --short HEAD)" 2>/dev/null; then
            echo -e "${GREEN}  âœ“ Updated successfully${NC}"
        else
            echo -e "${YELLOW}  Warning: Could not update ${repo_name}${NC}"
        fi
        
        cd "$CURRENT_DIR"
    else
        # Repository doesn't exist locally - clone it
        echo -e "  ðŸ†• ${YELLOW}Repository not found locally, cloning...${NC}"
        
        if git clone "$ssh_url" "$repo_name"; then
            echo -e "${GREEN}  âœ“ Cloned successfully${NC}"
        else
            echo -e "${RED}  âœ— Failed to clone ${repo_name}${NC}"
        fi
    fi

    # Brief pause between repositories to be gentle on the system
    sleep 0.5

    echo
done <<< "$REPOS"

echo -e "${GREEN}Repository sync completed!${NC}"